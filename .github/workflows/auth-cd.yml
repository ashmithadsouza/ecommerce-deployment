
name: Auth Service CD



on:

  workflow_run:

    workflows: ["Auth Service CI"]

    types: [completed]

    branches: [main]



# Add this block to fix the "Empty Secret" issue

permissions:

  contents: read

  packages: read



jobs:

  deploy-to-cloud-run:

    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    runs-on: ubuntu-latest

    

    steps:

      # Step 1: Always checkout, even if just for metadata

      - name: Checkout code

        uses: actions/checkout@v4



      # Step 2: Use v2 of the Auth action

      - name: Authenticate to Google Cloud

        uses: google-github-actions/auth@v2

        with:

          credentials_json: ${{ secrets.GCP_SA_KEY }}



      - name: Set up Cloud SDK

        uses: google-github-actions/setup-gcloud@v2



      - name: Deploy to Cloud Run

        run: |

          gcloud run deploy auth-service \

            --image ghcr.io/${{ github.repository_owner }}/auth-service:latest \

            --region us-central1 \

            --platform managed \

            --allow-unauthenticated \

            --port 8081

